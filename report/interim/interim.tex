\documentclass[11pt,twoside]{report}

% some definitions for the title page
\newcommand{\reporttitle}{Transfer Learning for bespoke automatic contouring of cervical cancer radiotherapy planning}
\newcommand{\reportauthor}{Anton Zhitomirsky}
\newcommand{\supervisor}{Ben Glocker}
\newcommand{\secondMarker}{TODO}
\newcommand{\reporttype}{MEng Individual Project}

\usepackage{pifont,mdframed}
\newenvironment{warning}
  {\par\begin{mdframed}[linewidth=1pt,linecolor=black]%
    \begin{list}{}{\leftmargin=1cm
                   \labelwidth=\leftmargin}\item[\Large\ding{43}]}
  {\end{list}\end{mdframed}\par}

% load some definitions and default packages
\input{../includes}

% load some macros
\input{../notation}

\addbibresource{../../research/source/bibliography.bib}

% load title page
\begin{document}
\input{../titlepage}


% page numbering etc.
\pagenumbering{roman}
\clearpage{\pagestyle{empty}\cleardoublepage}
\setcounter{page}{1}
\pagestyle{fancy}

% \cleardoublepage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \section*{Acknowledgments}
% Comment this out if not needed.

% \clearpage{\pagestyle{empty}\cleardoublepage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{abstract} \label{sect:abstract}
  Clinicians target cancerous tumours by studying 3D contrasting images of cancerous tumours and surrounding soft tissues to plan targets for radiation therapy. The Royal Marsden Hospital is a key contributor of data for this project, which uses this approach to delineate tumours for cervical cancers. Typically after a gross tumour volume (GTV) is extrapolated from the relevant imaging modality, clinicians append tailored safety margins to also account for the microscopic cancerous spreads not visible in the scan to generate the planned target volume (PTV).

  The PTV area has to be generous enough to attempt to treat the problem in one-shot, yet conservative enough to not harm surrounding healthy tissue with radiation over the course of the treatment. Compounded with small sample size of labelled data this proposes a significant challenge for developing deep-learning segmentation models to identify an optimal PTV.

  Thus we propose a transfer learning strategy to utilize imaging models in similar domains to attempt to learn from the limited input size to provide clinicians with a faster and more accurate segmentation method.
\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%--- table of contents
% \fancyhead[RE,LO]{\sffamily {Table of Contents}}
\tableofcontents


\clearpage{\pagestyle{empty}\cleardoublepage}
\pagenumbering{arabic}
\setcounter{page}{1}
\fancyhead[LE,RO]{\slshape \rightmark}
\fancyhead[LO,RE]{\slshape \leftmark}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Introduction} \label{sect:intro}

\section{Clinical Context} \label{sect:clinical-context-summary}
% the problem is not trivial of outlining a mass on a scan, there is also an area of non-zero probability that the tumour has spread around microscopically. Need to make sure 

\section{Motivation}\label{sect:motivation}
% 

\section{Current Solutions}\label{sect:current-solutions}
% 

\section{Outline of Report}\label{sect:outline-of-report}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Background}\label{sect:background}

\section{Clinical Context}\label{sect:clinical-context}

``To administer radiotherapy we need to identify target structures and structures we want to protect (organs-at-risk). These all need to be delineated on each slice of a CT scan, so the amount of radiation planned to reach each area can be calculated and checked.

The clinical target volume is the area where there is likely microscopic cancer and this area needs to receive sufficient radiation doses to achieve cancer cure. As microscopic cancer cannot be seen on CT, the clinical target volume is not an obvious structure that can be drawn around. The CTV is however constructed based on an Oncologist's knowledge of where each particular cancer is likely to spread to. It is drawn based on guidelines, atlases and clinical information. There are currently no internationally agreed guidelines for exactly how the clinical target volume should be drawn for cervix cancer and practice varies. Practice varies based on how the individual components of the CTV are labelled and this in theory could make it difficult for an AI model to learn patterns (or to generate large quantities of similar quality training data).

For the purpose of reproducibility, all scans in this training data have been labelled consistently, to see if an AI model can learn cervical cancer CTV pattern detection. Clinical decisions also affect how many structures are included in the CTV and an AI model is not likely to be able to make these decisions. An AI model is therefore unlikely to be able to produce a perfect CTV for treatment and a clinician will have to select which components of the CTV are required. Training models capable of producing the substructures needed within the CTV that a clinician can select from could still overall save time and improve consistency within the radiotherapy planning process.
''

\section{Vanilla Image Segmentation Models}\label{sect:vanilla-image-segmentation-models}

\subsection{Convolutional Neural Networks (CNN)}\label{sect:CNNs}

\subsection{U-Net}\label{sect:u-net}

\subsection{nnU-Net}\label{sect:nnu-net}

\subsection{Traditional Limitations}\label{sect:vanilla-limitations}

\section{Transfer Learning}\label{sect:transfer-learning}

\subsection{Intuition}\label{sect:transfer-learning-intuition}

\subsection{Total Segmentator}\label{sect:totalseg}

\subsection{UniverSeg}\label{sect:universeg}

\subsection{SAM}\label{sect:sam}

\section{Summary}\label{sect:background-summary}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Base Line and Data}\label{sect:baseline-and-data}

\section{Data}\label{sect:data}

The data is acquired during a CT scan (Section \ref{sec:data-ct-scan}) and presented as a set of \texttt{NIfTI} (Section \ref{sec:data-file-format}) files provided by the Royal Marsden Hospital. The data is of 100 patients each with a variant of cervical cancer. We have obtained from the hospital a spreadsheet with additional notes about each patient which may be useful in training and debugging (Section \ref{sec:data-notes}). Finally, this data is labelled into 5 different classes as a binary segmentation problem (Section \ref{sec:data-delineation-classes}). Included is a set of 10 hold-out data items, which are patients with only the raw CT scan with no labels.

\subsection{CT scan}\label{sec:data-ct-scan}

Before we consider other aspects of the data it is helpful to consider the context from which it was extracted and therefore what we might expect to see. This data is in CT scan, and so will be the focus, although there exist other imaging modalities such as Magnetic Resonance Imaging (MRI) and others.

A CT Scan is an X-ray study, where a series of rays are rotated around a specified body part, and computer-generated cross-sectional images are produced \cite{file-formats}. The granularity or image slice thickness is decided by the operator or physician and ranges from 1mm to 10mm. Whilst the scanner rotates the X-ray tube the patient is slowly moved up or down in the table to produce different cross-section images. 
 
We therefore expect to receive a representation of the internal structure or functions of an atomic region in the form of an array of voxels. A voxel represents the value on a grid in three-dimensional space and is decided by the physician once they establish the slice thickness.

\subsection{File Format}\label{sec:data-file-format}

The files are stored in a \texttt{.nii} file format which defines a style of image called the `Neuroimaging Informatics Technology Initiative' (NIfTI) \cite{file-formats}. It serves as a lightweight alternative to other formats such as DICOM and eliminates ambiguity from spatial orientation information \cite{dicom-to-nifti-conversion}.

The file has a fixed-size header which stores information about the data collected. Table \ref{tab:nifti-header} summarizes some key attributes of the header. All other attributes not listed are handled by the SimpleITK library \cite{SimpleITK-paper} which we use to read and manipulate the data in this project. The library defines the image as a set of points in a grid occupying a physical region in space as defined by this metadata, and therefore is influenced by the origin, size, spacing and so on. 

\begin{table}[ht]
  \centering
  \begin{tabular}{>{\raggedright}p{1.5cm}p{8cm}p{4cm}}
      \toprule
      \textbf{Name} & \textbf{Meaning} & \textbf{Value example} \\
      \midrule
      dim & Image dimension & 3 512 512 193 1 1 1 1 \\
      bitpix & Number of bits per voxel & 32 \\
      pixdim & The grid spacing (voxel size) and optionally time interval & 0 1.3 1.3 2.5 0 0 0 0 \\
      xyzt\_units & indicates units of pixdim and defined in the C header, e.g. \texttt{NIFTI\_UNITS\_MM = 2} & 2 \\
      \bottomrule
  \end{tabular}
  \caption{Description of NIfTI header parameters relevant to this project \cite{dicom-to-nifti-conversion, nifti-headers, nifti-data-format}. Example values are taken from patient id:075.}
  \label{tab:nifti-header}
\end{table}

\subsection{Notes}\label{sec:data-notes}

The notes contain information about each of the 100 labelled data pairs \cite{AMLART-data}. This information can be helpful in debugging or troubleshooting. It also provides a good warning regarding the variability of the data. In particular some aspects to note are summarized in Table \ref{tab:notes-summary}.

\begin{table}[ht]
  \centering
  \begin{tabular}{>{\raggedright}p{3cm}p{6cm}p{6cm}}
      \toprule
      \textbf{Patient ID} & \textbf{Comment} & \textbf{Concern} \\
      \midrule
      zzAMLART003 & ``no GTVp'' & Some scans contain no visible tumour, but we still draw a CTV \\
      \midrule
      zzAMLART017 & ``only scanned bottom of kidneys'' & We should be cautious of variability of width scope given in our source data \\
      \midrule
      zzAMLART017 & ``missing left kidney'' & Unusual body anatomy might trip up the model, mentioned elsewhere are also  \\
      \midrule
      zzAMLART041 & ``extra slices'' & variability in voxels or quantity may require data pre-processing to eliminate data uncertainty \\
      \midrule
      zzAMLART055 & ``no contrast - hard to see LNs. NG tube in situ. posterior renal vein. small parametrium and low uterus'' & An edge case like this will require more thought \\
      \bottomrule
  \end{tabular}
  \caption{A few captivating notes about each patient and why it might be concerning}
  \label{tab:notes-summary}
\end{table}

There exist note entires for the majority of the 100 patients which weren't shown in Table \ref{tab:notes-summary}. Regardless, these notes are helpful to identify what type of pre-processing we must do in order to fully address some differences between patients. The concern is to not overfit on the 'normal' cases but also generalize and engineer a solution that is also open-minded to extreme or poorly captured cases; there is a vast variability in the anatomy of patients which makes computer vision tasks more challenging.

\subsection{Delineation classes}\label{sec:data-delineation-classes}

The clinicians at the Royal Marsden Hospital have provided segmentation labels for 5 high-priority classes of interest. These are the Bladder, Anorectum, CTVn, CTVp, and Parametrium. 

\subsubsection{Organs At Risk}\label{sec:data-organs-at-risk}

\begin{warning}
  Insert example figure for bladder and anorectum
\end{warning}

An organ at risk is an organ which has a substantial probability of being within the PTV despite being healthy. Any areas that are created around the area should actively avoid these organs because by overlapping with them we risk complicating the treatment and compromising the health of functioning organs.

Many anatomies have been provided in the risk categories, however, in particular we have been supplied with contours for the Bladder (Figure \ref{fig:example-bladder}) and the Anorectum (Figure \ref{fig:example-anorectum}). In particular, clinicians have identified that the Bladder may overlap with the CTVn (Section \ref{sec:data-CTVn}) and the Parametrium (Section \ref{sec:data-Parametrium}). 

\subsubsection{CTVp}\label{sec:data-CTVp}

\begin{warning}
  Find better figure for this
\end{warning}

% \begin{figure}[H]
%   \centering
%   \includegraphics[width=0.7\linewidth]{../figures/CTVp.png}
%   \captionof{figure}{The CTVp of an arbitrary patient}
%   \label{fig:example-CTVp}
% \end{figure}

The CTVp stands for the Primary Clinical Target Volume, see the example at Figure \ref{fig:example-CTVp}. This is the CTV where there may be local microscopic spread (uterus, cervix, upper vagina, primary tumour) \cite{AMLART-data}. This is the area that contains the tumour.

This isn't by any means an organ in a body, but rather an area comprised of other components formed by joining other structures together. The CTVp is an area defined in Equation \ref{eq:ctvp}.

\subsubsection{CTVn}\label{sec:data-CTVn}

\begin{warning}
  Find better figure for this
\end{warning}

% \begin{figure}[H]
%   \centering
%   \includegraphics[width=0.7\linewidth]{../figures/CTVn.png}
%   \captionof{figure}{The CTVn of an arbitrary patient}
%   \label{fig:example-CTVn}
% \end{figure}

The CTVn stands for Nodal Clinical Target Volume, see the example at Figure \ref{fig:example-CTVn}. This is the CTV where there may be microscopic spread to lymph nodes. It is drawn based on set margins around pelvic blood vessels and includes pelvic lymph nodes, common iliac lymph nodes and para-aortic lymph nodes \cite{AMLART-data}. 

Similarly to CTVp, this is a compound area with three groups of lymph nodes. In clinical practice, the number of these groups included in the CTV varies in each patient, depending on how advanced the disease is. Pathological lymph nodes (GTVn) are also included. The CTVn is an area defined in Equation \ref{eq:ctvn}.

\subsubsection{Parametrium}\label{sec:data-Parametrium}

\begin{warning}
  Find better figure for this
\end{warning}

% \begin{figure}[H]
%   \centering
%   \includegraphics[width=0.7\linewidth]{../figures/Parametrium.png}
%   \captionof{figure}{The Parametrium of an arbitrary patient}
%   \label{fig:example-parametrium}
% \end{figure}

The Parametrium (or Paravagina) is the tissue surrounding the cervix/vagina - at risk of local spread, see Figure \ref{fig:example-parametrium}. Drawn as a complete structure and editing back to the level of vagina to be included \cite{AMLART-data}.

\subsection{Establishing Rules for Structures}\label{sec:data-delineation-rules}

\begin{minipage}{0.5\textwidth}
  \subsubsection{Notation of Structures}
  \begin{enumerate}
    \item Let the Anorectum be denoted as $A$
    \item Let the Bladder be denoted as $B$
    \item Let the Cervix be denoted with $C$
    \item Let the CTVn be denoted with $C_n$
    \item Let the CTVp be denoted with $C_p$
    \item Let the GTVp be denoted with $G_p$
    \item Let the GTVn be denoted with $G_n$
    \item Let the Pelvic Lymph Node be denoted as $L_p$
    \item Let the Common Iliac Lymph Node be denoted as $L_i$
    \item Let the Para-aortic Lymph Node be denoted as $L_{pa}$
  \end{enumerate}
\end{minipage}%
\begin{minipage}{0.5\textwidth}

\begin{enumerate}
  \setcounter{enumi}{10}
  \item Let the Parametrium be denoted with $P$
  \item Let the Uterus be denoted with $U$
  \item Let the Vagina be denoted with $V$
\end{enumerate}

\subsubsection{Relationship between Structures}

\begin{enumerate}
  \item Let $O$ denote the set $O = \{B, A, C_n, C_p, P \}$ for a particular patient. If we want to talk about a specific patient, we should use the super-script notation to differentiate patients, e.g., $O^i = \{B^i, A^i, C_n^i, C_p^i, P^i\}$.
  \item Let the overlap of two structures be denoted by the set intersect symbol $\cap$.
  \item Let the joint area of two structures be denoted by the set union symbol $\cup$.
\end{enumerate}

% \vspace{4em}

\end{minipage}

\subsubsection{Rules}

The top 5 priority structures have been selected to identify and plan an area where radiotherapy should be used. With these structures, there are rules that the clinicians have outlined, they are quoted for clarification (these structures only refer to each independent patient):

\begin{enumerate}
  \item There should be no overlap between the CTVn, CTVp or Anorectum.Â 
  
  \begin{equation}
    \forall{i,j \in \{C_n, C_p, A\}}\text{ with } i \neq j, i \cap j = \emptyset
  \end{equation}

  \item The Parametrium may overlap with all of the other structures.
  
  \begin{equation}
    \forall i \in S, \quad P \cap S_i \neq \emptyset \quad \text{(Possibly)}
  \end{equation}

  \item The Bladder may overlap with the CTVn.
  
  \begin{equation}
    B \cap C_n \neq \emptyset \vee B \cap C_n = \emptyset
  \end{equation}

  \item The CTVp is defined as a compound structure containing:
  
  \begin{equation}
    C_p = \overbrace{C \cup G_p}^{\text{High Risk CTV}} \quad \cup \quad U \cup V\label{eq:ctvp}
  \end{equation}

  \item The CTVn is defined as a compound structure containing: 
  
  \begin{equation}
    C_n = G_n \cup L_i \cup L_p + L_{pa}
  \end{equation}
  
\end{enumerate}

\subsection{Data Cleaning}\label{sect:data-cleaning}

\begin{warning}
  TODO
\end{warning}

\section{Evaluation Metrics}\label{sect:evaluation-metrics}

\subsection{Geometric}\label{sect:geometric}

\subsection{Honorable mentions}\label{sect:evaluation-metrics-honorable-mentions}

\section{Baseline Results}\label{sect:baseline-results}

\begin{warning}
  TODO for all
\end{warning}

\subsection{nnU-Net}\label{sect:results-nnu-net}

\subsection{Total Segmentator}\label{sect:results-totalseg}

\subsection{UinverSeg}\label{sect:results-universeg}

\section{Summary}\label{sect:results-summary}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Proposal}\label{sect:proposal}

\begin{warning}
  Should we keep labels individual and segment them separately or should we segment it all in one shot?
\end{warning}

\begin{warning}
  Solution to resolution problem, down-sample all samples or think of average?
\end{warning}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Ethics}\label{sect:ethics}

This project involves very intimate and personal information of many female patients. Researchers may collaborate with third-parties by providing anonymized data which may not be reverse engineered back to the patient.
The lack of this effort may result in ``stigma, embarrassment, and discrimination'' \cite{health-privacy} if the data is misused.

\section{Patient disclosures}\label{sect:patient-disclosures}

The Royal Marsden Hospital doesn't require ``explicit consent'' for sharing collected clinical data with outside entities as long as the patient is made aware of the ways their ``de-identified/anonymized'' data may be used  \cite{royal-marsden-privacy-note}. Formalities are also arranged with Imperial Collage's Medical Imaging team such as acting as ``ethical data stewards'' \cite{ethics-imaging-AI}. Without such disclosure and anonymisation of data, patients may be reluctant to provide candid and complete disclosures of their sensitive information, even to physicians, which may prevent a full diagnosis if their data isn't maintained in an anonymous fashion.

The MIRA team acts as responsible data stewards by storing anonymized data within a folder on the college network. All provided data was anonymized by the Royal Marsden Hospital and sent to team MIRA in the \texttt{NIfTI} file format which discloses no personal identifiable information, as defined by GOV website \cite{gov-gdpr}. This folder contains security measures which limit the availability of data only to those with specific access rights. Furthermore, operating on the preamble of de-identified data further reduces individual patient risk in the event that data is ever brought outside the confines of this folder.

\section{Using the tool}

The applications of this tool bode well in the healthcare ecosystem as the community slowly realizes the importance of AI-powered tools for the next generation of medical technology. Radiology has been one application that has been most welcoming of the new advances in technology as there is potential for substantial aid by reducing manual labor, increasing precision and freeing up the primary care physician's time \cite{overview-of-ai-medicine}.

Yet, it is too early to take result the medical tool as gospel. For current cervical radiotherapy delineation tools, only 90\% of the output is considered as acceptable for clinical use \cite{auto-delineation-cervical-cancer-development}. The remainder therefore has the potential to cause more harm than good if not checked properly. For example, overlap of a PTV onto an organ-at-risk may invoke a cascade of negative effects for the patient. A potential cause may be the lack of multivariate analysis, where an oncologist would need to consider a variety of data, whereas this model only considers a single point of evidence (results of an imaging modality).

Therefore, a degree of supervision required from physicians has to be established if this tool is to be used in practice. Oncologists will be required to reverse-engineer results of the `black-box' to verify why a decision has been made. Secondly, the responsible party for incorrect decisions made by DL tools should also be determined \cite{AI-in-cancer-diagnosis-era}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\printbibliography
\addcontentsline{toc}{chapter}{Bibliography}

\end{document}